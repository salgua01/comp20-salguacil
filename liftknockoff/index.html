<!DOCTYPE html>
<html>
<head>
	<title>LiftKnockOff</title>
	<meta charset="utf-8"/>
	<meta name="viewport" content="initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="liftstyle.css">
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpT9gY9pILYh8MR61L3o-wekmz_Ex7Bbc&callback=initMap"></script>
<script type="text/javascript">
	var map;
	const myUsername = "Z9jVw7GQ";
	var myLat = 42.406292;
	var myLng = -71.119750;
	var all_markers = [];

	/*Function to create map. Adds position of the user and the otehers*/
	function initMap(){
		map = new google.maps.Map(document.getElementById('map'), {
			center: {lat: 42.406292, lng: -71.119750},
			zoom: 15});
		getMyLocation();
		loadUsers();
	}

	/*Funtion to retrieve user position and place a marker for it in the map*/
	function getMyLocation() {
		navigator.geolocation.getCurrentPosition(function(myPos){
			myLat = myPos.coords.latitude;
			myLng = myPos.coords.longitude;
			setMarker(myLat, myLng, myUsername);
		});
	}

	/*Function to set markers in the map.
	  Parameters: latitude, longitude, name of the position, and bool (true if user, false if others)*/
	function setMarker(lat, lng, tit){
		var location = new google.maps.LatLng(lat, lng);
		var marker = new google.maps.Marker({
			position: location,
			map: map,
			title: tit,
			icon: 'passenger.png'
		});
		if(tit == myUsername){
			marker.icon = 'car.png';
		}else if(tit == "WEINERMOBILE"){
			marker.icon = 'weinermobile.png';
		}
		all_markers.push(marker);
	}
	/*Simple function to turn meters into miles*/
	function toMiles(meters){
		return meters/1609.344;
	}
	/*Funtion to find nearest passenger.
	Returns a marker, with its position and title
	Used to show in infowindow when driver is selected*/
	function findNearest(marker){
		var closer = null;
		var smallestDist = 6378137;
		for(var i = 0; i < all_markers.length; i++){
			if(marker.title != all_markers[i].title){
				var currDist = google.maps.geometry.spherical.computeDistanceBetween(marker.position, all_markers[i].position)
				if(currDist < smallestDist){
					closer = all_markers[i];
				}
			}
		}
		return closer;
	}

	/*Function that finds any marker by its title if it exists. If it doesn't, it returns 0. 
	Used to find Weinermobile and user marker*/
	function findMarker(markerName){
		for (var i = 0; i < all_markers.length; i++) {
			if(all_markers[i].title == markerName)
			{
				return all_markers[i];
			}
		}
		return 0;
	}
	/*Function to set the content of the info window that opens at the click of the user.*/
	function setInfoWindow(marker){

		//No se como cojones pero tengo que hacer que responda a los clicks :)
		var contentString = '<p>Username: ' + marker.title + ' </p>';
		if(marker.title == myUsername){
			var closerPass = findNearest(marker);
			var closerDist = toMiles(google.maps.geometry.spherical.computeDistanceBetween(marker.position, closerPass.position));

			contentString += '<p>Distance to closer passenger: ' + closerDist + '</p>';

			if(findMarker("WEINERMOBILE") != 0){
				var weiner = findMarker("WEINERMOBILE");
				var distToWeiner = toMiles(google.maps.geometry.spherical.computeDistanceBetween(marker.position, weiner.position))
				contentString += '<p>Distance to Weinermobile: ' + distToWeiner +'</p>';
			}
		}else{
			var myMarker = findMarker(myUsername);
			var distFromMe = toMiles(google.maps.geometry.spherical.computeDistanceBetween(marker.position, myMarker.position));
			contentString += '<p>Distance from you: ' + distFromMe +'</p>';
		}

		var infowindow = new google.maps.InfoWindow({
			content: contentString
		})
	}

	/*Function to load users from API and set their markers in the map*/
	function loadUsers(){
		var xhr = new XMLHttpRequest();
		xhr.open('POST', "https://hans-moleman.herokuapp.com/rides");
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
		xhr.onreadystatechange = function () {
			if(xhr.readyState == 4 && xhr.status == 200){
				var all_info = xhr.responseText;
				var data = JSON.parse(all_info);
				var num_veh = data.vehicles.length;

				for (var i = 0; i < num_veh; i++) {
					var car = data.vehicles[i];
					setMarker(data.vehicles[i].lat, data.vehicles[i].lng, data.vehicles[i].username);
				}	
			}
			else if(xhr.readyState == 4 && xhr.status != 200){
				document.getElementById("infobox").innerHTML = "<p>Whoops, something went terribly wrong</p>";
			}
		}
		var request = "username="+myUsername+"&lat="+myLat+"&lng="+ myLng;
		xhr.send(request);
	} 

</script>

</head>

<body onload="initMap()">
	<div id="map"></div>
	<div id="infobox"></div>
</body>
</html>